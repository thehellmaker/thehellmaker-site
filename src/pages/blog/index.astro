---
import Layout from '../../layouts/StaticPage.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { User, users } from '../../consts';
import { getCollection } from 'astro:content';
import { Post, externalPosts } from '../../data/blog-posts';

// Fetch all blog posts
const allBlogPosts = await getCollection('blog');

// Transform and filter posts (show drafts in dev only)
let internalPosts = allBlogPosts
	.filter((post) => import.meta.env.DEV || !post.data.draft)
	.map((post) => {
		const authors = post.data.authors
			.map((author) => users.get(author))
			.filter((author): author is User => author !== undefined);
		const tags = post.data.tags ? post.data.tags.split(',').map((t: string) => t.trim()) : [];
		return new Post(
			post.data.title,
			`/blog/${post.id}/`,
			post.data.pubDate,
			authors,
			post.data.heroImage,
			post.data.draft || false,
			tags
		);
	});

// Combine internal and external posts
let posts = [...internalPosts, ...externalPosts];

// Sort all posts by date, newest first
posts.sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime());

// Extract all unique tags
const allTags = [...new Set(posts.flatMap(post => post.tags))].sort();
---

<Layout
	title="All Blog Posts"
	description="All blog posts on ML engineering, distributed systems, and production infrastructure."
>
	<header class="blog-header">
		<h1>All Blog Posts</h1>
		<p class="blog-description">Complete archive of posts on ML engineering, distributed systems, and production infrastructure.</p>
	</header>

	{allTags.length > 0 && (
		<div class="tags-filter">
			<span class="tags-label">Filter by tag:</span>
			<div class="tags-list">
				<button class="tag-btn active" data-tag="all">All</button>
				{allTags.map((tag) => (
					<button class="tag-btn" data-tag={tag}>{tag}</button>
				))}
			</div>
		</div>
	)}

	<hr class="divider" />

	<nav aria-label="Blog posts navigation">
		<section class="posts-list" aria-label="Blog posts list">
			{
				posts.map((post) => (
					<article class="post-item" data-tags={post.tags.join(',')}>
						<div class="post-date-row">
							<time datetime={post.pubDate.toISOString()} class="post-date">
								<FormattedDate date={post.pubDate} />:
							</time>
						</div>
						<div class="post-title-row">
							{post.draft && <span class="draft-badge">draft</span>}
							<a
								href={post.url}
								target={post.url.startsWith('http') ? '_blank' : undefined}
								rel={post.url.startsWith('http') ? 'noopener noreferrer' : undefined}
								class="post-link"
							>
								{post.title}
							</a>
						</div>
						{post.tags.length > 0 && (
							<div class="post-tags">
								{post.tags.map((tag) => (
									<span class="post-tag">{tag}</span>
								))}
							</div>
						)}
					</article>
				))
			}
		</section>
	</nav>
</Layout>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const tagButtons = document.querySelectorAll('.tag-btn');
		const posts = document.querySelectorAll('.post-item');

		tagButtons.forEach(btn => {
			btn.addEventListener('click', () => {
				const tag = btn.getAttribute('data-tag');

				// Update active state
				tagButtons.forEach(b => b.classList.remove('active'));
				btn.classList.add('active');

				// Filter posts
				posts.forEach(post => {
					const postTags = post.getAttribute('data-tags') || '';
					if (tag === 'all' || postTags.split(',').includes(tag)) {
						(post as HTMLElement).style.display = '';
					} else {
						(post as HTMLElement).style.display = 'none';
					}
				});
			});
		});
	});
</script>

<style>
	.blog-header {
		margin-bottom: 1.5rem;
	}

	.blog-header h1 {
		font-size: 1.8rem;
		margin-bottom: 1rem;
		font-weight: 700;
	}

	.blog-description {
		font-size: 1rem;
		color: rgb(var(--gray));
		line-height: 1.7;
	}

	.tags-filter {
		margin-bottom: 1rem;
	}

	.tags-label {
		font-size: 0.9rem;
		color: rgb(var(--gray));
		margin-right: 0.5rem;
	}

	.tags-list {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		margin-top: 0.5rem;
	}

	.tag-btn {
		background: rgb(var(--gray-light));
		border: none;
		padding: 0.3rem 0.7rem;
		border-radius: 4px;
		font-size: 0.8rem;
		cursor: pointer;
		transition: all 0.15s ease;
	}

	.tag-btn:hover {
		background: rgb(var(--gray));
		color: white;
	}

	.tag-btn.active {
		background: #2563eb;
		color: white;
	}

	.divider {
		border: none;
		border-top: 1px solid rgb(var(--gray-light));
		margin: 1.5rem 0;
	}

	.posts-list {
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	.post-item {
		display: grid;
		grid-template-columns: auto 1fr;
		gap: 1rem;
		line-height: 1.6;
		margin-bottom: 1rem;
	}

	.post-date-row {
		display: flex;
		align-items: flex-start;
	}

	.post-title-row {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.post-date {
		font-size: 0.95rem;
		color: rgb(var(--gray));
	}

	.post-link {
		color: #2563eb;
		text-decoration: none;
	}

	.post-link:hover {
		text-decoration: underline;
	}

	.draft-badge {
		display: inline-block;
		background: #f59e0b;
		color: white;
		font-size: 0.65rem;
		padding: 0.1rem 0.35rem;
		border-radius: 3px;
		font-weight: 600;
		text-transform: uppercase;
		vertical-align: middle;
	}

	.post-tags {
		display: flex;
		gap: 0.3rem;
		margin-top: 0.5rem;
		flex-wrap: wrap;
	}

	.post-tag {
		display: inline-block;
		font-size: 0.75rem;
		color: rgb(var(--gray));
		background: rgb(var(--gray-light));
		padding: 0.1rem 0.4rem;
		border-radius: 3px;
	}

	@media (max-width: 720px) {
		.blog-header h1 {
			font-size: 1.5rem;
		}

		.tags-list {
			gap: 0.3rem;
		}

		.tag-btn {
			padding: 0.2rem 0.5rem;
			font-size: 0.75rem;
		}

		.post-item {
			grid-template-columns: 1fr;
			gap: 0.25rem;
		}
	}
</style>
