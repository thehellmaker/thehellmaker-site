---
import Layout from '../layouts/StaticPage.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { User, users } from '../consts';
import { getCollection } from 'astro:content';
import { Post, externalPosts } from '../data/blog-posts';

// Fetch all blog posts
const allBlogPosts = await getCollection('blog');

// Transform and filter posts (show drafts in dev only)
let posts = allBlogPosts
	.filter((post) => import.meta.env.DEV || !post.data.draft)
	.map((post) => {
		const authors = post.data.authors
			.map((author) => users.get(author))
			.filter((author): author is User => author !== undefined);
		const tags = post.data.tags ? post.data.tags.split(',').map((t: string) => t.trim()) : [];
		return new Post(
			post.data.title,
			`/blog/${post.id}/`,
			post.data.pubDate,
			authors,
			post.data.heroImage,
			post.data.draft || false,
			tags
		);
	});

// Combine internal and external posts
let allPosts = [...posts, ...externalPosts];

// Sort all posts by date, newest first
allPosts.sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime());

// Show only top 7 on home page
const displayPosts = allPosts.slice(0, 7);
const hasMorePosts = allPosts.length > 7;

// Generate JSON-LD schema for the blog listing page
const jsonLd = {
	"@context": "https://schema.org",
	"@type": "Blog",
	"name": "ML Engineering & Distributed Systems Blog",
	"description": "I write about ML engineering, distributed systems, and production infrastructure. As someone who loves distributed systems and scalability, I share insights on model deployment, ML ops, and everything in between.",
	"url": Astro.url,
	"blogPost": allPosts.map(post => {
		return {
			"@type": "BlogPosting",
			"headline": post.title,
			"url": new URL(post.url, Astro.url).toString(),
			"datePublished": post.pubDate.toISOString(),
			"author": post.authors.map(author => ({
			"@type": "Person",
			"name": author.name,
			"url": author.url
			}))
		}
	}),
	"publisher": {
		"@type": "Organization",
		"name": "ML Engineering & Distributed Systems Blog",
		"logo": {
			"@type": "ImageObject",
			"url": new URL("/ironman.jpg", Astro.url).toString()
		}
	},
	"inLanguage": "en-US",
	"keywords": "ML engineering, distributed systems, machine learning, technical blog, system design, database engineering, backend development, ML infrastructure, ML ops, model deployment, model serving, ML pipeline, model monitoring, feature engineering, data pipeline, model optimization, ML architecture, distributed training, model inference, ML platform, model versioning, ML workflow, model registry, ML observability, model performance, ML scalability, distributed computing, system architecture, AI infrastructure, ML system design, model deployment patterns, ML infrastructure, model lifecycle management, ML data management, model evaluation, ML testing, model validation, ML production, model serving optimization"
};
---

<Layout
	title="ML Engineering & Distributed Systems Blog"
	description="I write about ML engineering, distributed systems, and production infrastructure. As someone who loves distributed systems and scalability, I share insights on model deployment, ML ops, and everything in between."
>
	<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
	
		<header class="blog-header">
			<h1>ML Engineering & Distributed Systems Blog</h1>
			<p class="blog-description">I write about ML engineering, distributed systems, and production infrastructure. These posts are my learning notes, written with LLM assistance. I'm a fan of LLMs and won't pretend otherwise. I direct the content, review everything, and work to keep the slop out. I try to go as deep as possible so the value you get (or I get when I revisit) is worth more than the feeling that it's just LLM-generated filler.</p>
		</header>

		<hr class="divider" />

		<nav aria-label="Blog posts navigation">
			<section class="posts-list" aria-label="Blog posts list">
				{
					displayPosts.map((post) => (
						<article class="post-item" itemscope itemtype="https://schema.org/BlogPosting">
							<div class="post-date-row">
								<time datetime={post.pubDate.toISOString()} itemprop="datePublished" class="post-date">
									<FormattedDate date={post.pubDate} />:
								</time>
							</div>
							<div class="post-content-column">
								<div class="post-title-row">
									{post.draft && <span class="draft-badge">draft</span>}
									<a
										href={post.url}
										target={post.url.startsWith('http') ? '_blank' : undefined}
										rel={post.url.startsWith('http') ? 'noopener noreferrer' : undefined}
										itemprop="url"
										class="post-link"
									>
										<span itemprop="headline">{post.title}</span>
									</a>
								</div>
								{post.tags.length > 0 && (
									<div class="post-tags">
										{post.tags.map((tag) => (
											<span class="post-tag">{tag}</span>
										))}
									</div>
								)}
							</div>
							<meta itemprop="author" content={post.authors.map((a: { name: string }) => a.name).join(', ')} />
						</article>
					))
				}
			</section>
			{hasMorePosts && (
				<a href="/blog" class="view-all-link">View all posts &rarr;</a>
			)}
		</nav>
</Layout>

<style>
	.blog-header {
		margin-bottom: 1.5rem;
	}

	.blog-header h1 {
		font-size: 1.8rem;
		margin-bottom: 1rem;
		font-weight: 700;
	}

	.blog-description {
		font-size: 1rem;
		color: rgb(var(--gray));
		line-height: 1.7;
		text-align: justify;
	}

	.divider {
		border: none;
		border-top: 1px solid rgb(var(--gray-light));
		margin: 2rem 0;
	}

	.posts-list {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.post-item {
		display: grid;
		grid-template-columns: auto 1fr;
		gap: 1rem;
		line-height: 1.6;
		margin-bottom: 1rem;
	}

	.post-date-row {
		display: flex;
		align-items: flex-start;
	}

	.post-title-row {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.post-date {
		font-size: 0.95rem;
		color: rgb(var(--gray));
	}

	.post-link {
		color: #2563eb;
		text-decoration: none;
	}

	.post-link:hover {
		text-decoration: underline;
	}

	.draft-badge {
		display: inline-block;
		background: #f59e0b;
		color: white;
		font-size: 0.65rem;
		padding: 0.1rem 0.35rem;
		border-radius: 3px;
		margin-right: 0.3rem;
		font-weight: 600;
		text-transform: uppercase;
		vertical-align: middle;
	}

	.post-tags {
		display: flex;
		gap: 0.3rem;
		margin-top: 0.5rem;
		flex-wrap: wrap;
	}

	.post-tag {
		display: inline-block;
		font-size: 0.75rem;
		color: rgb(var(--gray));
		background: rgb(var(--gray-light));
		padding: 0.1rem 0.4rem;
		border-radius: 3px;
	}

	.view-all-link {
		display: inline-block;
		margin-top: 1.5rem;
		color: #2563eb;
		text-decoration: none;
		font-size: 0.95rem;
	}

	.view-all-link:hover {
		text-decoration: underline;
	}

	@media (max-width: 720px) {
		.blog-header h1 {
			font-size: 1.5rem;
		}

		.post-item {
			grid-template-columns: 1fr;
			gap: 0.5rem;
			margin-bottom: 1.5rem;
		}

		.post-date-row {
			margin-bottom: 0;
		}

		.post-date {
			font-size: 0.85rem;
		}

		.post-tags {
			margin-top: 0.4rem;
		}

		.post-tag {
			font-size: 0.7rem;
		}
	}
</style>
